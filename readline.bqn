
ascâ†"`1234567890-=~!@#$%^&*()_+qwertyuiop[]QWERTYUIOP{}asdfghjkl;'ASDFGHJKL:""|zxcvbnm,./ZXCVBNM<>?"
uniâ†"ËœË˜Â¨â¼âŒœÂ´Ë7âˆÂ¯â€¢Ã·Ã—Â¬â‰âš‡âŸâ—¶âŠ˜âŠââ•âŸ¨âŸ©âˆšâ‹†âŒ½ğ•¨âˆŠâ†‘âˆ§yâŠ”âŠâŠÏ€â†â†’â†™ğ•â·ğ•£â‹YUâŠ‘âŠ’â³âŠ£âŠ¢â‰ğ•¤â†•ğ•—ğ•˜âŠ¸âˆ˜â—‹âŸœâ‹„â†©â†–ğ•ŠDğ”½ğ”¾Â«JâŒ¾Â»Â·Ë™|â¥Šğ•©â†“âˆ¨âŒŠnâ‰¡âˆ¾â‰â‰ â‹ˆğ•Câ’âŒˆNâ‰¢â‰¤â‰¥â‡"

eâ†@+27 â‹„ clearâ†eâˆ¾"[2K"âˆ¾eâˆ¾"[0G"

Replâ‡{ğ•Š opt:
  â€¢term.RawMode 1
  â€¢term.OutRaw â€¢ToUTF8 opt.prompt

  châ†âŸ¨âŸ© â‹„ psâ†0

  Cmdâ†{ch ğ•Š Â·: â€¢term.OutRaw clearâ‹„opt.Cmd ch}

  # add ğ•© into ch at ps position with ğ•¨ deletions
  Patchâ†{0=â‰ ch?âŸ¨âŸ©;âˆ¾(âˆ¾âŸœğ•©(-ğ•¨)âŠ¸â†“)Â¨âŒ¾(1âŠ¸â†‘) ps(âŠ¢âŠ”Ëœâ‰¤âŸœ(â†•â‰ ))ch} 

  # map of inputs to âŸ¨ch, ps, effâŸ© 
  # ch: new character list, ps: position, eff: side effect functionâŸ©
  Mapâ†{
    ğ•©:ğ•©â‰¡eâˆ¾"[D"             ? âŸ¨ch,            0âŒˆps-1,          {ğ•©}   âŸ©
  ; ğ•©:ğ•©â‰¡eâˆ¾"[C"             ? âŸ¨ch,            (â‰ ch)âŒŠps+1,      {ğ•©}   âŸ©
  ; ğ•©:ğ•©â‰¡â‰@+10              ? âŸ¨âŸ¨âŸ©,            0,               châŠ¸CmdâŸ© # enter
  ; ğ•©:ğ•©â‰¡â‰@+127             ? âŸ¨1 Patch "",    0âŒˆps-1,          {ğ•©}   âŸ© # backspace
  ; ğ•©:ğ•©â‰¡â‰@+21              ? âŸ¨âŸ¨âŸ©,            0,               {ğ•©}   âŸ© # ctrl+u
  ; ğ•©:0=â‰ ch                ? âŸ¨ğ•©,             1,               {ğ•©}   âŸ©
  ; ğ•©:'\'=ch(âŠ£âŠ‘Ëœ0âŒˆâ‰ âŠ¸âŒŠ)ps-1 ? zâ†uni/ËœascâˆŠğ•©
                             âŸ¨ch0â†1 Patch z, (â‰ z)+ps-1,       {ğ•©}   âŸ©
  ; ğ•©:                       âŸ¨ch0â†0 Patch ğ•©, ps+1,            {ğ•©}   âŸ© 
  }

  # if e consume chars until letter (ANSI format for keypresses)
  Inputâ†{
     ğ•Š@:ğ•Šâ€¢term.CharB@
  ;  ğ•Šğ•©:ğ•©=e?ğ•©âˆ¾eğ•Šâ€¢term.CharB@
  ;  ğ•Šğ•©:âŸ¨ğ•©âŸ©
  ; eğ•Šğ•©:âŠ‘ğ•©âˆŠâˆ¾+âŸœ(â†•26)Â¨"Aa"?ğ•©
  ; eğ•Šğ•©:ğ•©âˆ¾eğ•Šâ€¢term.CharB@
  }

  {ğ•Š:
    effâ†@â‹„châ€¿psâ€¿Effâ†©Map Input@
    Eff @

    â€¢term.OutRaw clear # clear line and set to start of line
    â€¢term.OutRaw â€¢ToUTF8 opt.prompt
    â€¢term.OutRaw â€¢ToUTF8 ch
    â€¢term.OutRaw eâˆ¾"["âˆ¾(â€¢Fmt (â‰ opt.prompt)+ps+1)âˆ¾"G"
    â€¢term.Flush@
  }â€¢_while_ 1 @
}
